<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ø³Ø­Ø¨ Secret Santa</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      text-align: center;
    }
    .draw-section {
      margin-top: 50px;
    }
    .result {
      margin-top: 30px;
      font-size: 22px;
      color: green;
    }
    .btn-draw {
      margin-top: 20px;
      padding: 10px 20px;
      font-size: 18px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    .btn-draw:hover {
      background-color: #45a049;
    }
  </style>
</head>
<body>

  <h1>ğŸ Ø§Ø³Ø­Ø¨ Ù‡Ø¯ÙŠØªÙƒ Ø§Ù„Ø³Ø±ÙŠØ© ğŸ</h1>

  <div class="draw-section">
    <label for="participantSelect">Ø§Ø®ØªØ± Ø§Ø³Ù…Ùƒ:</label><br><br>
    <select id="participantSelect"></select><br><br>

    <button class="btn-draw" onclick="drawRandomName()">Ø§Ø³Ø­Ø¨</button>

    <div class="result" id="result"></div>
  </div>

  <script>
    const participantSelect = document.getElementById('participantSelect');
    const resultDiv = document.getElementById('result');
    const allNames = JSON.parse(localStorage.getItem("names"));
    const allConflicts = JSON.parse(localStorage.getItem("conflicts")) || [];
    if (!localStorage.getItem("availableNames")) {
      localStorage.setItem("availableNames", JSON.stringify(allNames));
    }
    if (!localStorage.getItem("drawnBy")) {
      localStorage.setItem("drawnBy", JSON.stringify([]));
    }

    participantSelect.innerHTML = ''; // Ø¥ÙØ±Ø§Øº Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
    
    allNames.forEach(name => {
      const option = document.createElement('option');
      option.value = name;
      option.textContent = name;
      participantSelect.appendChild(option);
    });
    
    async function drawRandomName() {
      const currentName = participantSelect.value;
      if (!currentName) {
        alert("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ø³Ù…Ùƒ.");
        return;
      }

      const drawnBy = JSON.parse(localStorage.getItem("drawnBy")) || [];
      console.log(drawnBy)
      if (drawnBy.includes(currentName)) {
        resultDiv.textContent = "Ù„Ù‚Ø¯ Ù‚Ù…Øª Ø¨Ø§Ù„Ø³Ø­Ø¨ Ù…Ø³Ø¨Ù‚Ù‹Ø§.";
        return;
      }
      
      const availableNames = JSON.parse(localStorage.getItem("availableNames")) || [];

      // Ø£Ø³Ù…Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø³Ø­Ø¨Ù‡Ø§ Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
      const forbidden = new Set();
      forbidden.add(currentName); // Ù„Ø§ ÙŠØ³Ø­Ø¨ Ù†ÙØ³Ù‡

      // ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØªØ¹Ø§Ø±Ø¶Ø§Øª
      allConflicts.forEach(conflict => {
        if (
          conflict.conflictType === "One-way" &&
          conflict.participant1 === currentName
        ) {
          //participant1 Ù„Ø§ ÙŠØ³Ø­Ø¨ participant2
          forbidden.add(conflict.participant2);
        } else if (
          conflict.conflictType === "Two-way" &&
          (conflict.participant1 === currentName || conflict.participant2 === currentName)
        ) {
          // ÙƒÙ„Ø§ Ø§Ù„Ø·Ø±ÙÙŠÙ† Ù„Ø§ ÙŠØ³Ø­Ø¨ Ø§Ù„Ø¢Ø®Ø±
          forbidden.add(conflict.participant1);
          forbidden.add(conflict.participant2);
        }
      });

      // ÙÙ„ØªØ±Ø© Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ø³Ù…ÙˆØ­Ø©
      const candidates = availableNames.filter(name => !forbidden.has(name));

      if (candidates.length === 0) {
        resultDiv.textContent = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ù…Ø§Ø¡ Ù…ØªØ§Ø­Ø© Ù„Ù„Ø³Ø­Ø¨.";
        return;
      }

      const drawnName = candidates[Math.floor(Math.random() * candidates.length)];

      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØªØ§Ø­Ø© Ù„Ù„Ø³Ø­Ø¨
      const updatedAvailable = availableNames.filter(name => name !== drawnName);
      localStorage.setItem("availableNames", JSON.stringify(updatedAvailable));

      // ØªØ³Ø¬ÙŠÙ„ Ù…Ù† Ù‚Ø§Ù… Ø¨Ø§Ù„Ø³Ø­Ø¨
      drawnBy.push(currentName);
      localStorage.setItem("drawnBy", JSON.stringify(drawnBy));

      await updateSession();

      resultDiv.innerHTML = `
        <p>ğŸ‰ ØªÙ‡Ø§Ù†ÙŠÙ†Ø§ ${currentName}!</p>
        <p>Ø£Ù†Øª Ø³ØªÙÙ‡Ø¯ÙŠ: <strong>${drawnName}</strong> ğŸ</p>
        <p>Ø­Ø¯ Ø§Ù„Ù‡Ø¯ÙŠØ©: <strong></strong></p>
      `;
    }

    async function updateSession() {
      const sessionId = localStorage.getItem("sessionId");
      const JSONBIN_URL = localStorage.getItem("JSONBIN_URL");
      const JSONBIN_API_KEY = localStorage.getItem("JSONBIN_API_KEY");
      const names = JSON.parse(localStorage.getItem("names"));
      const availableNames = JSON.parse(localStorage.getItem("availableNames"));
      const conflicts = JSON.parse(localStorage.getItem("conflicts"));
      const drawnBy = JSON.parse(localStorage.getItem("drawnBy"));
      if (!sessionId) return;

      const updatedData = {
        names,
        availableNames,
        conflicts,
        drawnBy
      };

      try {
        await fetch(`${JSONBIN_URL}/${sessionId}`, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
            "X-Master-Key": JSONBIN_API_KEY
          },
          body: JSON.stringify(updatedData)
        });
      } catch (err) {
        console.error("ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ù„Ø³Ø©:", err);
      }
    }
  </script>

</body>
</html>
